#!/usr/bin/env perl
use strict;
use warnings;
use Try::Tiny;
use lib 'lib';
use Hush::List;
use Hush::Util qw/barf/;
use Data::Dumper;
use Hush::RPC; #hack

my $rpc           = Hush::RPC->new;
my $chaininfo     = $rpc->getblockchaininfo;
my $walletinfo    = $rpc->getwalletinfo;
my $chain         = $chaininfo->{chain};
my $blocks        = $chaininfo->{blocks};
my $balance       = $rpc->z_gettotalbalance;
my $tbalance      = $balance->{transparent};
my $zbalance      = $balance->{private};
my $total_balance = $balance->{total};

print "Hushlist running on $chain chain, $blocks blocks\n";
print "Balances: transparent $tbalance HUSH, private $zbalance HUSH\n";
exit;

# we only need one
my $list    = Hush::List->new;
my $command = shift || help();

my $COMMANDS = {
    "add"     =>   \&add,
    "contact" =>   \&contact,
    "new"     =>   \&new,
    "remove"  =>   \&remove,
    "send"    =>   \&send,
};
run();

sub help {
    print "It would be nice to give some help\n";
}

sub contact {
    my $cmd = shift || '';
    if ($cmd eq 'new') {
        # add a hust contact, yay
        my ($name,$zaddr) = @ARGV;
        die Dumper [ $name, $zaddr ];
    }
}

sub new {
    my $name = shift || '';
    #TODO: better validation and allow safe unicode stuff
    die "Invalid hushlist name '$name' !" unless $name && ($name =~ m/^[A-z0-9_-]{0,64}/);

    $list->new_list($name);
    print "hushlist '$name' created, enjoy your private comms :)\n";
}

sub run {
    print "Running command $command\n";
    my $cmd = $COMMANDS->{$command};

    if ($cmd) {
        $cmd->(@ARGV);
    } else {
        help();
    }
}

sub add {
    my ($list_name,$zaddr) = @_;

    $list->add_zaddr($list_name,$zaddr);
}

sub remove {
    my ($list_name,$zaddr) = @_;

    $list->remove_zaddr($list_name,$zaddr);
}

sub send {
    my ($list_name,$from,$memo) = @_;

    $list->send_message($from, $list_name, $memo);
}
